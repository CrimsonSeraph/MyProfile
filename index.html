<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 设置视口属性，确保页面在移动设备上正确缩放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在加载</title>
    <!-- 引入全局样式表 -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 错误信息样式 - 仅在重定向失败时显示 */
        .error-message {
            display: none; /* 默认隐藏 */
            background-color: rgba(231, 76, 60, 0.1); /* 浅红色背景 */
            border: 1px solid #e74c3c; /* 红色边框 */
            border-radius: var(--border-radius); /* 使用CSS变量中的圆角值 */
            padding: 15px; /* 内边距 */
            margin-top: 20px; /* 上边距 */
            max-width: 500px; /* 最大宽度 */
            text-align: center; /* 文本居中 */
        }

        /* 重试按钮样式 */
        .retry-button {
            margin-top: 15px; /* 上边距 */
            padding: 8px 20px; /* 内边距 */
            background-color: #e74c3c; /* 红色背景 */
            color: white; /* 白色文字 */
            border: none; /* 无边框 */
            border-radius: var(--border-radius); /* 圆角 */
            cursor: pointer; /* 鼠标指针变为手形 */
            font-weight: 500; /* 字体粗细 */
            transition: var(--transition); /* 平滑过渡效果 */
        }

            /* 重试按钮悬停效果 */
            .retry-button:hover {
                background-color: #c0392b; /* 深红色 */
                transform: translateY(-2px); /* 轻微上移 */
            }
    </style>
</head>
<body>
    <!-- 加载容器 - 包含所有加载动画元素 -->
    <div class="loader-container">
        <!-- 量子加载动画 -->
        <div class="quantum-loader">
            <!-- 5个彩色粒子，每个有不同位置和颜色 -->
            <div class="quantum-particle"></div>
            <div class="quantum-particle"></div>
            <div class="quantum-particle"></div>
            <div class="quantum-particle"></div>
            <div class="quantum-particle"></div>
        </div>

        <!-- 进度条容器 -->
        <div class="progress-container">
            <!-- 动态进度条 -->
            <div class="progress-bar"></div>
        </div>

        <!-- 加载文本 - 每个字母有独立动画 -->
        <div class="loading-text">
            <span>L</span>
            <span>o</span>
            <span>a</span>
            <span>d</span>
            <span>i</span>
            <span>n</span>
            <span>g</span>
        </div>

        <p class="loading-hint">正在连接到服务，请稍候...</p>

        <!-- 错误信息容器 - 默认隐藏 -->
        <div class="error-message" id="errorMessage">
            <p>无法完成重定向。可能是网络问题或配置错误。</p>
            <p>错误代码: <span id="errorCode">未知</span></p>
            <!-- 重试按钮 -->
            <button class="retry-button" id="retryButton">重试</button>
        </div>
    </div>

    <!-- 引入主JavaScript文件 -->
    <script src="js/script.js"></script>

    <!-- 重定向 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 获取注入的目标页面
            const targetPage = window.targetPage || '/Global.html';
            const retryButton = document.getElementById('retryButton');

            // 控制变量
            let redirectAttempted = false;
            let redirectSucceeded = false;

            // 获取进度条元素
            const progressBar = document.querySelector('.progress-bar');

            // 5秒超时检查（仅用于最终错误处理）
            const errorTimeout = setTimeout(showError, 5000);

            // 页面可见性变化检测
            document.addEventListener('visibilitychange', function () {
                if (document.visibilityState === 'hidden') {
                    // 页面开始卸载，说明重定向成功
                    redirectSucceeded = true;
                    clearTimeout(errorTimeout);
                }
            });

            // 进度条动画结束后触发重定向
            progressBar.addEventListener('animationend', function () {
                if (!redirectAttempted) {
                    redirectToTarget(targetPage);
                }
            });

            // 重试按钮功能
            retryButton.addEventListener('click', () => {
                if (!redirectSucceeded) {
                    redirectToTarget(targetPage);
                }
            });

            function redirectToTarget(target) {
                // 创建文件路径
                const targetPath = window.location.href.replace(/[^/]*$/, '') + target;

                try {
                    console.log(`尝试重定向到: ${targetPath}`);

                    // 使用 iframe 预加载目标页面
                    const preloadFrame = document.createElement('iframe');
                    preloadFrame.style.display = 'none';
                    preloadFrame.src = targetPath; // 使用完整路径
                    document.body.appendChild(preloadFrame);

                    // 监听预加载完成事件
                    preloadFrame.onload = function () {
                        console.log(`目标页面预加载完成: ${targetPath}`);
                        // 实际重定向
                        window.location.replace(targetPath);
                    };

                    preloadFrame.onerror = function () {
                        console.error(`目标页面加载失败: ${targetPath}`);
                        showError();
                    };
                } catch (e) {
                    console.error("重定向失败:", e);
                    showError();
                }
            }

            function showError() {
                if (!redirectSucceeded && !redirectAttempted) {
                    document.getElementById('errorMessage').style.display = 'block';
                    const errorCode = Math.floor(1000 + Math.random() * 9000);
                    document.getElementById('errorCode').textContent = `ERR_${errorCode}`;

                    // 停止进度条动画
                    progressBar.style.animation = 'none';
                }
            }
        });
    </script>
</body>
</html>